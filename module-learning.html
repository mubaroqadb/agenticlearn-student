<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Learning - AgenticLearn</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå±</text></svg>">
    
    <!-- Import Shared CSS -->
    <link rel="stylesheet" href="https://mubaroqadb.github.io/agenticlearn-shared/css/green-components.css">
    
    <style>
        :root {
            --primary: #2563eb; --success: #059669; --gray-50: #f9fafb;
            --gray-100: #f3f4f6; --gray-800: #1f2937; --shadow: 0 1px 3px rgba(0,0,0,0.12);
            --radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50); line-height: 1.6; color: var(--gray-800);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .card { 
            background: white; border-radius: var(--radius); padding: 1.5rem; 
            box-shadow: var(--shadow); margin-bottom: 1rem;
        }
        .btn { 
            padding: 0.5rem 1rem; border: none; border-radius: var(--radius); 
            cursor: pointer; background: var(--primary); color: white;
            font-size: 0.875rem; transition: all 0.2s ease; text-decoration: none;
            display: inline-block;
        }
        .btn:hover { background: #3b82f6; }
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #047857; }
        .grid { 
            display: grid; grid-template-columns: 1fr 300px; 
            gap: 1rem; 
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
        .progress-bar { 
            background: var(--gray-100); height: 8px; border-radius: 4px; 
            overflow: hidden; margin: 1rem 0;
        }
        .progress-fill { 
            background: linear-gradient(90deg, var(--primary), #3b82f6);
            height: 100%; transition: width 0.5s ease;
        }
        .lesson-nav {
            border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem;
        }
        .lesson-item {
            padding: 0.75rem; margin: 0.5rem 0; border-radius: 4px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .lesson-item:hover { background: var(--gray-50); }
        .lesson-item.active { background: var(--primary); color: white; }
        .lesson-content {
            min-height: 400px; padding: 2rem;
        }
        .quiz-container {
            background: #f8fafc; border-radius: 6px; padding: 1.5rem; margin: 1rem 0;
        }
        .quiz-question {
            margin-bottom: 1.5rem;
        }
        .quiz-options {
            display: flex; flex-direction: column; gap: 0.75rem;
        }
        .quiz-option {
            padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .quiz-option:hover { background: var(--gray-50); border-color: var(--primary); }
        .quiz-option.selected { background: var(--primary); color: white; }

        /* Enhanced Quiz Styles */
        .quiz-header { margin-bottom: 2rem; text-align: center; }
        .quiz-info { display: flex; justify-content: center; gap: 1rem; margin: 1rem 0; flex-wrap: wrap; }
        .quiz-timer { background: #fef3c7; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; margin: 1rem 0; }
        .quiz-progress { margin-bottom: 2rem; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #059669, #2563eb); transition: width 0.3s ease; }
        .quiz-question { margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb; }
        .question-context { font-style: italic; color: #6b7280; margin: 0.5rem 0; }
        .quiz-option { display: flex; align-items: center; gap: 0.75rem; }
        .quiz-option input[type="radio"] { margin: 0; width: 1.25rem; height: 1.25rem; }
        .quiz-option label { cursor: pointer; flex: 1; margin: 0; }
        .question-points { text-align: right; color: #6b7280; margin-top: 0.5rem; }
        .quiz-actions { display: flex; gap: 1rem; justify-content: center; margin: 2rem 0; flex-wrap: wrap; }
        .quiz-results { background: white; border-radius: 8px; padding: 2rem; border: 1px solid #e5e7eb; margin-top: 2rem; }
        .assessment-results { text-align: center; }
        .score-display { margin-bottom: 2rem; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #059669, #2563eb); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .score-number { color: white; font-size: 2rem; font-weight: bold; }
        .results-details { text-align: left; margin-bottom: 1.5rem; background: #f8fafc; padding: 1.5rem; border-radius: 6px; }
        .results-details p { margin-bottom: 0.5rem; }
        .question-review { text-align: left; margin: 2rem 0; }
        .question-result { margin: 1rem 0; padding: 1rem; border-radius: 6px; border-left: 4px solid; }
        .question-result.correct { background: #f0fdf4; border-left-color: #059669; }
        .question-result.incorrect { background: #fef2f2; border-left-color: #ef4444; }
        .recommendations { text-align: left; background: #fef3c7; padding: 1.5rem; border-radius: 6px; margin: 1.5rem 0; }
        .recommendations ul { margin-top: 0.5rem; padding-left: 1.5rem; }
        .results-actions { margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }

        .back-link {
            color: var(--primary); text-decoration: none; margin-bottom: 1rem; display: inline-block;
        }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
        
        <div id="module-header" class="card">
            <div class="loading"></div> Loading module...
        </div>

        <div class="grid">
            <div>
                <div id="lesson-content" class="card">
                    <div class="lesson-content">
                        <div class="loading"></div> Loading lesson content...
                    </div>
                </div>
            </div>
            
            <div>
                <div id="lesson-navigation" class="card">
                    <h3>üìã Lessons</h3>
                    <div id="lessons-list">
                        <div class="loading"></div> Loading lessons...
                    </div>
                </div>
                
                <div id="progress-panel" class="card">
                    <h3>üìä Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="module-progress" style="width: 0%"></div>
                    </div>
                    <div id="progress-info">
                        <p>0% Complete</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import main script as ES6 module -->
    <script type="module">
        import { getCookie } from "https://cdn.jsdelivr.net/gh/jscroot/lib@0.0.4/cookie.js";
        import { setInner } from "https://cdn.jsdelivr.net/gh/jscroot/lib@0.0.4/element.js";

        // Get module ID and lesson ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const moduleId = urlParams.get('id');
        const lessonId = urlParams.get('lesson');
        const autostart = urlParams.get('autostart') === 'true';

        console.log("üìã URL Parameters:");
        console.log("- moduleId:", moduleId);
        console.log("- lessonId:", lessonId);
        console.log("- autostart:", autostart);

        let currentModule = null;
        let currentLessonIndex = 0;
        let completedLessons = [];

        if (!moduleId) {
            setInner("module-header", `
                <h1>‚ùå Module Not Found</h1>
                <p>No module ID provided. Please return to the dashboard.</p>
                <a href="index.html" class="btn">Back to Dashboard</a>
            `);
        } else {
            loadModuleContent(moduleId);
        }

        // API client with enhanced functionality
        const apiClient = {
            async request(endpoint, options = {}) {
                try {
                    const token = getCookie("access_token") || getCookie("login");
                    const baseURL = "http://localhost:8080/api/v1";

                    const config = {
                        method: options.method || 'GET',
                        headers: {
                            "Authorization": token ? `Bearer ${token}` : "",
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        }
                    };

                    if (options.body) {
                        config.body = JSON.stringify(options.body);
                    }

                    const response = await fetch(`${baseURL}${endpoint}`, config);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error("API Error:", error);
                    throw error;
                }
            }
        };

        // Compatibility API client for shared components
        window.compatApiClient = apiClient;

        // UI Components for notifications
        window.UIComponents = {
            showNotification: function(message, type = "info") {
                console.log(`[${type.toUpperCase()}] ${message}`);

                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 1000;
                    padding: 1rem 1.5rem; border-radius: 6px; color: white;
                    font-weight: 500; max-width: 400px; word-wrap: break-word;
                    background: ${type === 'success' ? '#059669' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#2563eb'};
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    transform: translateX(100%); transition: transform 0.3s ease;
                `;
                notification.textContent = message;

                document.body.appendChild(notification);

                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                // Auto remove
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 4000);
            }
        };

        async function loadModuleContent(moduleId) {
            try {
                console.log("Loading module content for:", moduleId);
                console.log("Lesson ID from URL:", lessonId);

                // Handle case where only lesson ID is provided
                if (!moduleId && lessonId) {
                    console.log("üîÑ No module ID, inferring from lesson ID:", lessonId);
                    // Map lesson ID to module ID
                    const lessonToModuleMap = {
                        'demo-lesson-1': 'demo-module-1',
                        'demo-lesson-2': 'demo-module-1',
                        'demo-lesson-3': 'demo-module-2',
                        'demo-lesson-4': 'demo-module-2'
                    };

                    const inferredModuleId = lessonToModuleMap[lessonId] || 'demo-module-1';
                    console.log("üéØ Inferred module ID:", inferredModuleId);

                    // Update URL to include module ID
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('id', inferredModuleId);
                    if (!newUrl.searchParams.has('lesson')) {
                        newUrl.searchParams.set('lesson', lessonId);
                    }
                    window.history.replaceState({}, '', newUrl);

                    // Use inferred module ID
                    moduleId = inferredModuleId;
                }

                // First try to find the module from course data
                // Since we don't have direct module endpoint, we'll use demo data
                // or try to get from course details

                // Try to load from course data first
                let moduleFound = false;

                // Check if we have course ID in URL or try to find module in courses
                const courseId = urlParams.get('courseId') || '68471ea555df4b1a863cb123'; // default course

                try {
                    const courseResponse = await apiClient.request(`/learning/courses/${courseId}`);
                    if (courseResponse.status === 'success' && courseResponse.data.modules) {
                        const modules = courseResponse.data.modules;
                        currentModule = modules.find(m => m._id === moduleId);

                        if (currentModule) {
                            moduleFound = true;
                            console.log("‚úÖ Found module in course data:", currentModule);
                        }
                    }
                } catch (courseError) {
                    console.log("Course data not available, using demo module");
                }

                // If not found, use demo data
                if (!moduleFound) {
                    console.log("üé≠ Loading demo module data");
                    currentModule = getDemoModule(moduleId);
                }

                if (currentModule) {
                    // Display module header
                    setInner("module-header", `
                        <h1>üìñ ${currentModule.title}</h1>
                        <p>${currentModule.description}</p>
                        <div style="margin: 1rem 0;">
                            <span class="badge">Week ${currentModule.week_start || '?'}-${currentModule.week_end || '?'}</span>
                            <span class="badge">${currentModule.lessons ? currentModule.lessons.length : 'Demo'} lessons</span>
                            ${!moduleFound ? '<span class="badge" style="background: #059669;">Demo Mode</span>' : ''}
                        </div>
                        ${currentModule.objectives ? `
                            <div style="margin: 1rem 0;">
                                <h4>üéØ Learning Objectives:</h4>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                    ${currentModule.objectives.map(obj => `<li>${obj}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    `);

                    // Load lessons
                    const lessons = currentModule.lessons || getDemoLessons();
                    if (lessons && lessons.length > 0) {
                        loadLessonsNavigation(lessons);

                        // Determine which lesson to start with
                        let startLessonIndex = 0;

                        if (lessonId) {
                            // Specific lesson requested
                            const lessonIndex = lessons.findIndex(lesson => lesson._id === lessonId);
                            if (lessonIndex !== -1) {
                                startLessonIndex = lessonIndex;
                                console.log("üéØ Loading specific lesson:", lessonId, "at index:", startLessonIndex);
                            }
                        } else if (autostart) {
                            // Autostart from "Mulai Module" - start with first lesson
                            startLessonIndex = 0;
                            console.log("üöÄ Autostart mode - starting with first lesson");
                        }

                        loadLesson(startLessonIndex); // Load determined lesson
                    } else {
                        setInner("lessons-list", "<p>No lessons available for this module.</p>");
                        setInner("lesson-content", `
                            <div class="lesson-content">
                                <h2>Module Content Coming Soon</h2>
                                <p>This module is being developed. Please check back later.</p>
                            </div>
                        `);
                    }
                } else {
                    throw new Error("Module not found");
                }

            } catch (error) {
                console.error("Failed to load module content:", error);
                setInner("module-header", `
                    <h1>‚ùå Error Loading Module</h1>
                    <p>Failed to load module content: ${error.message}</p>
                    <a href="index.html" class="btn">Back to Dashboard</a>
                `);
            }
        }

        function getDemoModule(moduleId) {
            const demoModules = {
                'demo-module-1': {
                    _id: 'demo-module-1',
                    title: 'Digital Literacy Essentials',
                    description: 'Foundational digital skills untuk business professionals',
                    week_start: 1,
                    week_end: 2,
                    objectives: [
                        'Master professional digital communication',
                        'Implement cloud-based business workflows',
                        'Understand digital security best practices',
                        'Use collaboration tools effectively'
                    ]
                },
                'demo-module-2': {
                    _id: 'demo-module-2',
                    title: 'Digital Marketing Fundamentals',
                    description: 'Essential digital marketing strategies for Indonesian businesses',
                    week_start: 3,
                    week_end: 5,
                    objectives: [
                        'Develop effective social media marketing strategies',
                        'Create engaging content for Indonesian audience',
                        'Implement email marketing campaigns',
                        'Analyze digital marketing performance'
                    ]
                }
            };

            // Return specific module or first one as default
            return demoModules[moduleId] || demoModules['demo-module-1'];
        }

        function getDemoLessons() {
            return [
                {
                    _id: 'demo-lesson-1',
                    title: 'Professional Digital Communication',
                    description: 'Master email, messaging, and video conferencing for business',
                    type: 'video',
                    duration: 45
                },
                {
                    _id: 'demo-lesson-2',
                    title: 'Cloud Computing Basics',
                    description: 'Understanding cloud storage and collaboration tools',
                    type: 'reading',
                    duration: 30
                },
                {
                    _id: 'demo-lesson-3',
                    title: 'Digital Security Fundamentals',
                    description: 'Protecting your business data and communications',
                    type: 'interactive',
                    duration: 60
                },
                {
                    _id: 'demo-lesson-4',
                    title: 'Knowledge Check',
                    description: 'Test your understanding of digital literacy concepts',
                    type: 'quiz',
                    duration: 15
                }
            ];
        }

        function loadLessonsNavigation(lessons) {
            let lessonsHTML = "";
            
            lessons.forEach((lesson, index) => {
                const isCompleted = completedLessons.includes(index);
                const isActive = index === currentLessonIndex;
                
                lessonsHTML += `
                    <div class="lesson-item ${isActive ? 'active' : ''}" onclick="loadLesson(${index})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${isCompleted ? '‚úÖ' : 'üìù'} ${lesson.title}</span>
                            <span style="font-size: 0.75rem; opacity: 0.8;">${lesson.duration}min</span>
                        </div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">
                            ${lesson.type}
                        </div>
                    </div>
                `;
            });
            
            setInner("lessons-list", lessonsHTML);
            updateProgress();
        }

        function loadLesson(index) {
            const lessons = currentModule?.lessons || getDemoLessons();
            if (!lessons || index >= lessons.length) {
                return;
            }

            currentLessonIndex = index;
            const lesson = lessons[index];
            
            let contentHTML = `
                <div class="lesson-content">
                    <h2>${lesson.title}</h2>
                    <p style="color: #6b7280; margin-bottom: 2rem;">
                        ${lesson.type} ‚Ä¢ ${lesson.duration} minutes
                    </p>
                    
                    <div class="lesson-body">
                        ${generateLessonContent(lesson)}
                    </div>
                    
                    <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: space-between;">
                        <button class="btn" onclick="previousLesson()" ${index === 0 ? 'disabled' : ''}>
                            ‚Üê Previous
                        </button>
                        <div>
                            <button class="btn btn-success" onclick="completeLesson(${index})">
                                Mark Complete
                            </button>
                            <button class="btn" onclick="nextLesson()" ${index === lessons.length - 1 ? 'disabled' : ''}>
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            setInner("lesson-content", contentHTML);
            loadLessonsNavigation(lessons); // Refresh navigation
        }

        function generateLessonContent(lesson) {
            switch (lesson.type) {
                case 'video':
                    return `
                        <div style="background: #f3f4f6; padding: 2rem; border-radius: 8px; text-align: center;">
                            <h3>üé• Video Lesson</h3>
                            <p>Video content for: ${lesson.title}</p>
                            <div style="margin: 1rem 0;">
                                <div style="width: 100%; height: 200px; background: #e5e7eb; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: #6b7280;">Video Player Placeholder</span>
                                </div>
                            </div>
                            <p style="font-size: 0.875rem; color: #6b7280;">
                                This video covers the fundamentals of ${lesson.title.toLowerCase()}.
                            </p>
                        </div>
                    `;
                
                case 'quiz':
                    return generateQuizContent(lesson);
                
                case 'reading':
                default:
                    return `
                        <div>
                            <h3>üìö Reading Material</h3>
                            <p>${lesson.description}</p>
                            
                            <div style="margin: 2rem 0;">
                                <h4>Key Learning Points:</h4>
                                <ul style="margin: 1rem 0; padding-left: 2rem;">
                                    <li>Understanding the core concepts of ${lesson.title}</li>
                                    <li>Practical applications in real-world scenarios</li>
                                    <li>Best practices and common pitfalls to avoid</li>
                                    <li>Integration with other course modules</li>
                                </ul>
                            </div>
                            
                            <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #2563eb;">
                                <h4 style="color: #2563eb;">üí° Pro Tip</h4>
                                <p>Take notes while reading and try to relate the concepts to your own experience. This will help reinforce your learning.</p>
                            </div>
                        </div>
                    `;
            }
        }

        function generateQuizContent(lesson) {
            // Get quiz data from lesson or generate comprehensive quiz
            const quizData = lesson.content?.quiz || generateComprehensiveQuiz(lesson);

            if (!quizData || !quizData.questions || quizData.questions.length === 0) {
                return `
                    <div class="quiz-container">
                        <h3>üìù Assessment</h3>
                        <p>No quiz available for this lesson.</p>
                        <button class="btn" onclick="completeLesson(currentLessonIndex)">Mark as Complete</button>
                    </div>
                `;
            }

            // Store quiz data globally for submission
            window.currentQuiz = {
                lessonId: lesson._id || lesson.id,
                lessonTitle: lesson.title,
                questions: quizData.questions,
                passScore: quizData.pass_score || 70,
                timeLimit: quizData.time_limit || 15,
                startTime: new Date().toISOString(),
                answers: new Array(quizData.questions.length).fill(null)
            };

            let quizHTML = `
                <div class="quiz-container">
                    <div class="quiz-header">
                        <h3>üéØ Quiz: ${lesson.title}</h3>
                        <div class="quiz-info">
                            <span class="badge">‚è±Ô∏è ${window.currentQuiz.timeLimit} minutes</span>
                            <span class="badge">üìä Pass: ${window.currentQuiz.passScore}%</span>
                            <span class="badge">‚ùì ${quizData.questions.length} questions</span>
                        </div>
                        <div class="quiz-timer" id="quiz-timer">
                            <span id="timer-display">‚è±Ô∏è ${window.currentQuiz.timeLimit}:00</span>
                        </div>
                    </div>

                    <div class="quiz-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="quiz-progress-fill" style="width: 0%"></div>
                        </div>
                        <span id="quiz-progress-text">Question 1 of ${quizData.questions.length}</span>
                    </div>
            `;

            quizData.questions.forEach((q, qIndex) => {
                quizHTML += `
                    <div class="quiz-question" data-question="${qIndex}">
                        <h4>Question ${qIndex + 1}: ${q.question}</h4>
                        ${q.explanation ? `<p class="question-context">${q.explanation}</p>` : ''}
                        <div class="quiz-options">
                `;

                q.options.forEach((option, oIndex) => {
                    quizHTML += `
                        <div class="quiz-option" onclick="selectQuizOption(${qIndex}, ${oIndex})" data-question="${qIndex}" data-option="${oIndex}">
                            <input type="radio" name="question_${qIndex}" value="${oIndex}" id="q${qIndex}_o${oIndex}">
                            <label for="q${qIndex}_o${oIndex}">${option}</label>
                        </div>
                    `;
                });

                quizHTML += `
                        </div>
                        <div class="question-points">
                            <small>Points: ${q.points || 1}</small>
                        </div>
                    </div>
                `;
            });

            quizHTML += `
                    <div class="quiz-actions">
                        <button class="btn" onclick="submitQuiz()" id="submit-quiz-btn" disabled>Submit Quiz</button>
                        <button class="btn" onclick="resetQuiz()" style="background: #6b7280;">Reset Answers</button>
                    </div>

                    <div class="quiz-results" id="quiz-results" style="display: none;">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            `;

            // Start quiz timer
            setTimeout(() => startQuizTimer(), 1000);

            return quizHTML;
        }

        function updateProgress() {
            const lessons = currentModule?.lessons || getDemoLessons();
            const totalLessons = lessons.length;
            const completed = completedLessons.length;
            const percentage = Math.round((completed / totalLessons) * 100);

            document.getElementById("module-progress").style.width = `${percentage}%`;
            setInner("progress-info", `
                <p>${percentage}% Complete</p>
                <p>${completed} of ${totalLessons} lessons completed</p>
            `);
        }

        // Global functions
        window.loadLesson = loadLesson;
        
        window.previousLesson = function() {
            if (currentLessonIndex > 0) {
                loadLesson(currentLessonIndex - 1);
            }
        };
        
        window.nextLesson = function() {
            const lessons = currentModule?.lessons || getDemoLessons();
            if (currentLessonIndex < lessons.length - 1) {
                loadLesson(currentLessonIndex + 1);
            }
        };
        
        window.completeLesson = function(index) {
            if (!completedLessons.includes(index)) {
                completedLessons.push(index);
                alert(`Lesson completed! üéâ`);
                const lessons = currentModule?.lessons || getDemoLessons();
                loadLessonsNavigation(lessons);

                // Auto-advance to next lesson
                if (index < lessons.length - 1) {
                    setTimeout(() => loadLesson(index + 1), 1000);
                }
            }
        };
        
        function generateComprehensiveQuiz(lesson) {
            // Generate contextual quiz based on lesson content
            const lessonType = lesson.type || 'general';
            const lessonTitle = lesson.title || 'Lesson';

            const quizTemplates = {
                'video': {
                    questions: [
                        {
                            question: `What is the main concept discussed in "${lessonTitle}"?`,
                            options: [
                                "Theoretical framework only",
                                "Practical implementation and real-world application",
                                "Historical background information",
                                "Future predictions and trends"
                            ],
                            correct_answer: "1",
                            explanation: "This lesson focuses on practical implementation that can be applied in real business scenarios.",
                            points: 2
                        },
                        {
                            question: `How can you apply the concepts from "${lessonTitle}" in Indonesian business context?`,
                            options: [
                                "Use international standards without adaptation",
                                "Adapt strategies to local market conditions and culture",
                                "Focus only on Jakarta market",
                                "Ignore local regulations"
                            ],
                            correct_answer: "1",
                            explanation: "Successful implementation requires adaptation to local Indonesian market conditions and cultural context.",
                            points: 3
                        }
                    ]
                },
                'reading': {
                    questions: [
                        {
                            question: `Based on the reading material "${lessonTitle}", what is the key takeaway?`,
                            options: [
                                "Memorize all technical details",
                                "Understand core principles and their applications",
                                "Focus on theoretical aspects only",
                                "Skip practical examples"
                            ],
                            correct_answer: "1",
                            explanation: "The key is understanding core principles that can be applied in various business situations.",
                            points: 2
                        }
                    ]
                },
                'interactive': {
                    questions: [
                        {
                            question: `In the interactive lesson "${lessonTitle}", what was the most important skill demonstrated?`,
                            options: [
                                "Technical knowledge only",
                                "Problem-solving and critical thinking",
                                "Memorization of facts",
                                "Following instructions exactly"
                            ],
                            correct_answer: "1",
                            explanation: "Interactive lessons emphasize developing problem-solving and critical thinking skills.",
                            points: 3
                        },
                        {
                            question: `How would you implement the interactive concepts in your own business?`,
                            options: [
                                "Copy the exact same approach",
                                "Adapt the principles to your specific business needs",
                                "Use only the technical aspects",
                                "Ignore the business context"
                            ],
                            correct_answer: "1",
                            explanation: "Success comes from adapting principles to your specific business context and needs.",
                            points: 2
                        }
                    ]
                }
            };

            const template = quizTemplates[lessonType] || quizTemplates['video'];

            return {
                questions: template.questions,
                pass_score: 70,
                time_limit: 10
            };
        }

        window.selectQuizOption = function(questionIndex, optionIndex) {
            // Remove previous selections for this question
            document.querySelectorAll(`[data-question="${questionIndex}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });

            // Add selection to clicked option
            const clickedOption = document.querySelector(`[data-question="${questionIndex}"][data-option="${optionIndex}"]`);
            if (clickedOption) {
                clickedOption.classList.add('selected');

                // Update radio button
                const radio = clickedOption.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;

                // Store answer
                if (window.currentQuiz) {
                    window.currentQuiz.answers[questionIndex] = optionIndex.toString();
                    updateQuizProgress();
                    checkQuizCompletion();
                }
            }
        };

        function updateQuizProgress() {
            if (!window.currentQuiz) return;

            const answeredQuestions = window.currentQuiz.answers.filter(answer => answer !== null).length;
            const totalQuestions = window.currentQuiz.questions.length;
            const progressPercentage = Math.round((answeredQuestions / totalQuestions) * 100);

            const progressFill = document.getElementById('quiz-progress-fill');
            const progressText = document.getElementById('quiz-progress-text');

            if (progressFill) progressFill.style.width = `${progressPercentage}%`;
            if (progressText) progressText.textContent = `${answeredQuestions} of ${totalQuestions} questions answered`;
        }

        function checkQuizCompletion() {
            if (!window.currentQuiz) return;

            const allAnswered = window.currentQuiz.answers.every(answer => answer !== null);
            const submitBtn = document.getElementById('submit-quiz-btn');

            if (submitBtn) {
                submitBtn.disabled = !allAnswered;
                if (allAnswered) {
                    submitBtn.textContent = 'Submit Quiz ‚úÖ';
                    submitBtn.style.background = 'var(--success)';
                }
            }
        }

        function startQuizTimer() {
            if (!window.currentQuiz) return;

            let timeLeft = window.currentQuiz.timeLimit * 60; // Convert to seconds
            const timerDisplay = document.getElementById('timer-display');

            window.quizTimer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;

                if (timerDisplay) {
                    timerDisplay.textContent = `‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}`;

                    // Change color when time is running out
                    if (timeLeft <= 60) {
                        timerDisplay.style.color = '#ef4444'; // Red
                    } else if (timeLeft <= 300) {
                        timerDisplay.style.color = '#f59e0b'; // Orange
                    }
                }

                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(window.quizTimer);
                    autoSubmitQuiz();
                }
            }, 1000);
        }

        function autoSubmitQuiz() {
            UIComponents.showNotification("‚è∞ Time's up! Quiz auto-submitted.", "warning");
            submitQuiz(true);
        }

        window.resetQuiz = function() {
            if (!window.currentQuiz) return;

            if (confirm("Are you sure you want to reset all answers?")) {
                // Clear all selections
                document.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = false;
                });

                // Reset answers array
                window.currentQuiz.answers = new Array(window.currentQuiz.questions.length).fill(null);

                // Update UI
                updateQuizProgress();
                checkQuizCompletion();

                UIComponents.showNotification("Quiz reset successfully", "info");
            }
        };

        window.submitQuiz = async function(autoSubmit = false) {
            if (!window.currentQuiz) {
                UIComponents.showNotification("No quiz data available", "error");
                return;
            }

            // Stop timer
            if (window.quizTimer) {
                clearInterval(window.quizTimer);
            }

            // Calculate score
            const results = calculateQuizScore();

            // Show results
            displayQuizResults(results, autoSubmit);

            // Try to submit to backend
            try {
                await submitQuizToBackend(results);
            } catch (error) {
                console.error("Failed to submit quiz to backend:", error);
                UIComponents.showNotification("Quiz saved locally (offline mode)", "warning");
            }

            // Mark lesson as complete if passed
            if (results.passed) {
                setTimeout(() => {
                    completeLesson(currentLessonIndex);
                }, 2000);
            }
        };

        function calculateQuizScore() {
            if (!window.currentQuiz) return null;

            const quiz = window.currentQuiz;
            let totalPoints = 0;
            let earnedPoints = 0;
            let correctAnswers = 0;
            const questionResults = [];

            quiz.questions.forEach((question, index) => {
                const userAnswer = quiz.answers[index];
                const correctAnswer = question.correct_answer;
                const points = question.points || 1;
                const isCorrect = userAnswer === correctAnswer;

                totalPoints += points;
                if (isCorrect) {
                    earnedPoints += points;
                    correctAnswers++;
                }

                questionResults.push({
                    question: question.question,
                    userAnswer: userAnswer !== null ? question.options[parseInt(userAnswer)] : 'Not answered',
                    correctAnswer: question.options[parseInt(correctAnswer)],
                    isCorrect,
                    points,
                    earnedPoints: isCorrect ? points : 0,
                    explanation: question.explanation
                });
            });

            const scorePercentage = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
            const passed = scorePercentage >= quiz.passScore;

            return {
                scorePercentage,
                earnedPoints,
                totalPoints,
                correctAnswers,
                totalQuestions: quiz.questions.length,
                passed,
                passScore: quiz.passScore,
                questionResults,
                submissionTime: new Date().toISOString(),
                timeSpent: Math.round((new Date() - new Date(quiz.startTime)) / 1000) // seconds
            };
        }

        function displayQuizResults(results, autoSubmit = false) {
            const resultsContainer = document.getElementById('quiz-results');
            if (!resultsContainer) return;

            const statusColor = results.passed ? '#059669' : '#ef4444';
            const statusIcon = results.passed ? 'üéâ' : 'üìö';
            const statusText = results.passed ? 'Passed!' : 'Needs Review';

            const resultsHTML = `
                <div class="assessment-results">
                    <div class="score-display">
                        <div class="score-circle" style="background: linear-gradient(135deg, ${statusColor}, #2563eb);">
                            <div class="score-number">${results.scorePercentage}%</div>
                        </div>
                        <h3>${statusIcon} ${statusText}</h3>
                        ${autoSubmit ? '<p><em>Quiz auto-submitted due to time limit</em></p>' : ''}
                    </div>

                    <div class="results-details">
                        <p><strong>Score:</strong> ${results.earnedPoints}/${results.totalPoints} points (${results.scorePercentage}%)</p>
                        <p><strong>Correct Answers:</strong> ${results.correctAnswers}/${results.totalQuestions}</p>
                        <p><strong>Pass Score:</strong> ${results.passScore}%</p>
                        <p><strong>Time Spent:</strong> ${Math.floor(results.timeSpent / 60)}:${(results.timeSpent % 60).toString().padStart(2, '0')}</p>
                        <p><strong>Status:</strong> ${results.passed ? '‚úÖ Passed' : '‚ùå Failed'}</p>
                    </div>

                    <div class="question-review">
                        <h4>üìã Question Review:</h4>
                        ${results.questionResults.map((q, index) => `
                            <div class="question-result ${q.isCorrect ? 'correct' : 'incorrect'}" style="margin: 1rem 0; padding: 1rem; border-radius: 6px; background: ${q.isCorrect ? '#f0fdf4' : '#fef2f2'};">
                                <h5>Question ${index + 1}: ${q.question}</h5>
                                <p><strong>Your Answer:</strong> ${q.userAnswer}</p>
                                <p><strong>Correct Answer:</strong> ${q.correctAnswer}</p>
                                <p><strong>Points:</strong> ${q.earnedPoints}/${q.points}</p>
                                ${q.explanation ? `<p><strong>Explanation:</strong> ${q.explanation}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>

                    ${!results.passed ? `
                        <div class="recommendations">
                            <h4>üìö Recommendations:</h4>
                            <ul>
                                <li>Review the lesson content again</li>
                                <li>Focus on the concepts you missed</li>
                                <li>Try the quiz again after studying</li>
                                <li>Ask for help if you need clarification</li>
                            </ul>
                        </div>
                    ` : ''}

                    <div class="results-actions" style="margin-top: 2rem;">
                        ${results.passed ?
                            '<button class="btn" onclick="continueToNextLesson()">Continue to Next Lesson üöÄ</button>' :
                            '<button class="btn" onclick="retryQuiz()">Retry Quiz üîÑ</button>'
                        }
                        <button class="btn" onclick="backToLessonContent()" style="background: #6b7280;">Review Lesson</button>
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.style.display = 'block';

            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth' });

            // Show notification
            const message = results.passed ?
                `üéâ Great job! You scored ${results.scorePercentage}%` :
                `üìö Score: ${results.scorePercentage}%. Review and try again!`;
            UIComponents.showNotification(message, results.passed ? "success" : "warning");
        }

        async function submitQuizToBackend(results) {
            if (!window.currentQuiz) return;

            const submissionData = {
                answers: window.currentQuiz.answers,
                start_time: window.currentQuiz.startTime
            };

            try {
                const response = await compatApiClient.request(
                    `/learning/assessment/lessons/${window.currentQuiz.lessonId}/quiz`,
                    {
                        method: 'POST',
                        body: submissionData
                    }
                );

                if (response.status === 'success') {
                    console.log("‚úÖ Quiz submitted to backend successfully");
                    UIComponents.showNotification("Quiz submitted successfully! üéØ", "success");
                    return response.data;
                } else {
                    throw new Error(response.message || 'Submission failed');
                }
            } catch (error) {
                console.error("‚ùå Failed to submit quiz to backend:", error);
                throw error;
            }
        }

        window.continueToNextLesson = function() {
            const lessons = currentModule?.lessons || getDemoLessons();
            if (currentLessonIndex < lessons.length - 1) {
                loadLesson(currentLessonIndex + 1);
            } else {
                UIComponents.showNotification("üéâ Module completed! Great job!", "success");
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        };

        window.retryQuiz = function() {
            // Reset quiz and reload lesson
            if (window.currentQuiz) {
                window.currentQuiz = null;
            }
            if (window.quizTimer) {
                clearInterval(window.quizTimer);
            }

            loadLesson(currentLessonIndex);
            UIComponents.showNotification("Quiz reset. Good luck! üçÄ", "info");
        };

        window.backToLessonContent = function() {
            // Hide quiz results and show lesson content
            const resultsContainer = document.getElementById('quiz-results');
            if (resultsContainer) {
                resultsContainer.style.display = 'none';
            }

            // Scroll back to lesson content
            document.querySelector('.lesson-content').scrollIntoView({ behavior: 'smooth' });
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üå± Module Learning page loaded");
            console.log("üìã Initial parameters - moduleId:", moduleId, "lessonId:", lessonId, "autostart:", autostart);

            // Check if we have either module ID or lesson ID
            if (!moduleId && !lessonId) {
                setInner("module-header", `
                    <h1>‚ùå Module Not Found</h1>
                    <p>No module ID or lesson ID provided. Please return to the dashboard.</p>
                    <a href="index.html" class="btn">Back to Dashboard</a>
                `);
                return;
            }

            // If we only have lesson ID, loadModuleContent will handle the inference
            const targetModuleId = moduleId || 'demo-module-1'; // fallback
            await loadModuleContent(targetModuleId);
        });
    </script>
</body>
</html>
